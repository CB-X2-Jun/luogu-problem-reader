# æ´›è°·é¢˜ç›®è‡ªåŠ¨çˆ¬å–å·¥ä½œæµ
name: Crawl Luogu Problems

on:
  # æ‰‹åŠ¨è§¦å‘ï¼Œæ”¯æŒå‚æ•°é…ç½®
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'æ‰¹é‡çˆ¬å–æ•°é‡'
        required: true
        default: '20'
        type: string
      from_head:
        description: 'ä»å¤´å¼€å§‹çˆ¬å– (P1000å¼€å§‹ï¼Œè€Œä¸æ˜¯ä»æœ€åä¸€é¢˜ç»§ç»­)'
        required: true
        default: false
        type: boolean
  
  # å®šæ—¶è§¦å‘ - æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨çˆ¬å–æ–°é¢˜ç›®
  schedule:
    - cron: '0 2 * * *'

# æƒé™è®¾ç½®
permissions:
  contents: write

jobs:
  crawl-and-commit:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 markdown markdownify
          
      - name: é…ç½®çˆ¬å–å‚æ•°
        id: config
        run: |
          # è®¾ç½®é»˜è®¤å‚æ•°
          BATCH_SIZE="${{ github.event.inputs.batch_size || '20' }}"
          FROM_HEAD="${{ github.event.inputs.from_head || 'false' }}"
          
          echo "batch_size=$BATCH_SIZE" >> $GITHUB_OUTPUT
          echo "from_head=$FROM_HEAD" >> $GITHUB_OUTPUT
          
          echo "é…ç½®å‚æ•°:"
          echo "- æ‰¹é‡æ•°é‡: $BATCH_SIZE"
          echo "- ä»å¤´å¼€å§‹: $FROM_HEAD"
          
      - name: çˆ¬å–æ´›è°·é¢˜ç›®
        run: |
          echo "å¼€å§‹çˆ¬å–æ´›è°·é¢˜ç›®..."
          
          # æ„å»ºçˆ¬å–å‘½ä»¤
          CRAWL_CMD="python fetch_luogu_problems_html2md.py"
          
          # æ·»åŠ æ‰¹é‡æ•°é‡å‚æ•°
          CRAWL_CMD="$CRAWL_CMD ${{ steps.config.outputs.batch_size }}"
          
          # æ·»åŠ ä»å¤´å¼€å§‹å‚æ•°ï¼ˆå¦‚æœå¯ç”¨ï¼‰
          if [ "${{ steps.config.outputs.from_head }}" = "true" ]; then
            CRAWL_CMD="$CRAWL_CMD -f"
          fi
          
          echo "æ‰§è¡Œå‘½ä»¤: $CRAWL_CMD"
          
          # æ‰§è¡Œçˆ¬å–ï¼Œè®¾ç½®è¶…æ—¶30åˆ†é’Ÿ
          timeout 1800 $CRAWL_CMD || {
            echo "çˆ¬å–è¶…æ—¶æˆ–è¢«ä¸­æ–­ï¼Œç»§ç»­éƒ¨ç½²å·²çˆ¬å–çš„å†…å®¹"
          }
          
      - name: ç”Ÿæˆé¢˜ç›®åˆ—è¡¨
        run: |
          echo "ç”Ÿæˆé¢˜ç›®åˆ—è¡¨..."
          python -c "
          import sys
          sys.path.append('.')
          from fetch_luogu_problems_html2md import generate_problem_list
          generate_problem_list()
          print('é¢˜ç›®åˆ—è¡¨ç”Ÿæˆå®Œæˆ!')
          "
          
      - name: ç»Ÿè®¡çˆ¬å–ç»“æœ
        run: |
          echo "=== çˆ¬å–ç»Ÿè®¡ ==="
          PROBLEM_COUNT=$(find problem -name "P*" -type d 2>/dev/null | wc -l)
          echo "æ€»é¢˜ç›®æ•°é‡: $PROBLEM_COUNT"
          
          # æ£€æŸ¥æœ€æ–°é¢˜ç›®
          if [ "$PROBLEM_COUNT" -gt 0 ]; then
            LATEST_PROBLEM=$(find problem -name "P*" -type d 2>/dev/null | sort -V | tail -1)
            if [ -n "$LATEST_PROBLEM" ]; then
              LATEST_PROBLEM=$(basename "$LATEST_PROBLEM")
              echo "æœ€æ–°é¢˜ç›®: $LATEST_PROBLEM"
            else
              echo "æœ€æ–°é¢˜ç›®: æ— "
            fi
          else
            echo "æœ€æ–°é¢˜ç›®: æ— "
          fi
          
          # æ£€æŸ¥æ ·ä¾‹æ•°æ®
          SAMPLE_COUNT=$(find problem -name "index.md" -exec grep -l "è¾“å…¥è¾“å‡ºæ ·ä¾‹" {} \; 2>/dev/null | wc -l)
          echo "åŒ…å«æ ·ä¾‹çš„é¢˜ç›®: $SAMPLE_COUNT"
          
      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet && git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–°çš„æ›´æ”¹éœ€è¦æäº¤"
            exit 0
          fi
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹
          git add .
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          COMMIT_MSG="ğŸ¤– è‡ªåŠ¨çˆ¬å–æ´›è°·é¢˜ç›®"
          
          if [ "${{ steps.config.outputs.from_head }}" = "true" ]; then
            COMMIT_MSG="$COMMIT_MSG (ä»P1000å¼€å§‹)"
          else
            COMMIT_MSG="$COMMIT_MSG (ç»§ç»­çˆ¬å–)"
          fi
          
          COMMIT_MSG="$COMMIT_MSG - æ•°é‡:${{ steps.config.outputs.batch_size }} - $(date '+%Y-%m-%d %H:%M:%S')"
          
          git commit -m "$COMMIT_MSG"
          
      - name: æ¨é€æ›´æ”¹
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
          
      - name: æ¸…ç†éƒ¨ç½²æ–‡ä»¶
        run: |
          # åˆ é™¤Pythonç›¸å…³æ–‡ä»¶ï¼Œé¿å…Jekyllå¤„ç†é—®é¢˜
          rm -rf __pycache__/ *.py *.pyc
          rm -f requirements.txt
          # ä¿ç•™.nojekyllæ–‡ä»¶ç¡®ä¿ç¦ç”¨Jekyll
          echo "æ¸…ç†å®Œæˆï¼Œä¿ç•™é™æ€æ–‡ä»¶"
          ls -la
          
      - name: é…ç½®GitHub Pages
        uses: actions/configure-pages@v5
        
      - name: ä¸Šä¼ é™æ€æ–‡ä»¶
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
          
      - name: éƒ¨ç½²åˆ°GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ æ´›è°·é¢˜ç›®çˆ¬å–å’Œéƒ¨ç½²å®Œæˆ!"
          echo "ğŸ“Š ç½‘ç«™åœ°å€: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“ æœ¬æ¬¡çˆ¬å–å‚æ•°:"
          echo "   - æ‰¹é‡æ•°é‡: ${{ steps.config.outputs.batch_size }}"
          echo "   - ä»å¤´å¼€å§‹: ${{ steps.config.outputs.from_head }}"
