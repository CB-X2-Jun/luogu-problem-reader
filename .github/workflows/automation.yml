name: Automation & Maintenance

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´00:00è¿è¡Œç»Ÿè®¡ (åŒ—äº¬æ—¶é—´08:00)
    - cron: '0 0 * * *'
    # æ¯å‘¨äº”UTCæ—¶é—´04:00è¿è¡Œå¯è§†åŒ– (åŒ—äº¬æ—¶é—´12:00)
    - cron: '0 4 * * 5'
    # æ¯æœˆ1å·UTCæ—¶é—´02:00è¿è¡ŒSEOä¼˜åŒ– (åŒ—äº¬æ—¶é—´10:00)
    - cron: '0 2 1 * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      tasks:
        description: 'é€‰æ‹©è¦è¿è¡Œçš„ä»»åŠ¡'
        required: false
        default: 'all'
        type: choice
        options:
        - 'all'
        - 'daily-stats'
        - 'data-visualization'
        - 'seo-optimization'
        - 'theme-automation'
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æ‰€æœ‰æ•°æ®'
        required: false
        default: false
        type: boolean

jobs:
  # æ¯æ—¥ç»Ÿè®¡å’Œæ¨è
  daily-stats:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 0 * * *' || github.event.inputs.tasks == 'all' || github.event.inputs.tasks == 'daily-stats'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 markdown markdownify pygments
    
    - name: Generate Daily Statistics
      run: |
        python scripts/generate_daily_stats.py
    
    - name: Generate Problem Recommendation
      run: |
        python scripts/daily_recommendation.py
    
    - name: Update README with Stats
      run: |
        python scripts/update_readme_stats.py
    
    - name: Commit and Push Changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add stats/ README.md
        git diff --staged --quiet || git commit -m "ğŸ“Š Daily stats update - $(date +'%Y-%m-%d')"
        git push

  # æ•°æ®å¯è§†åŒ–
  data-visualization:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 4 * * 5' || github.event.inputs.tasks == 'all' || github.event.inputs.tasks == 'data-visualization'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 markdown markdownify pygments matplotlib seaborn plotly pandas numpy wordcloud
    
    - name: Generate Charts and Visualizations
      run: |
        python scripts/generate_charts.py
    
    - name: Create Interactive Dashboard
      run: |
        python scripts/create_dashboard.py
    
    - name: Generate Analytics Report
      run: |
        python scripts/analytics_report.py
    
    - name: Commit and Push Changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add charts/ dashboard/
        git diff --staged --quiet || git commit -m "ğŸ“Š Data visualization update - $(date +'%Y-%m-%d')"
        git push

  # SEOä¼˜åŒ–
  seo-optimization:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 2 1 * *' || github.event.inputs.tasks == 'all' || github.event.inputs.tasks == 'seo-optimization'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 markdown markdownify pygments
    
    - name: Generate Sitemap
      run: |
        python scripts/generate_sitemap.py
    
    - name: Update Meta Tags
      run: |
        python scripts/update_meta_tags.py
    
    - name: Update Robots.txt
      run: |
        python scripts/update_robots.py
    
    - name: Generate Search Index
      run: |
        python scripts/generate_search_index.py
    
    - name: Commit and Push Changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add sitemap.xml robots.txt search/
        git diff --staged --quiet || git commit -m "ğŸ” SEO optimization update - $(date +'%Y-%m-%d')"
        git push

  # ä¸»é¢˜è‡ªåŠ¨åŒ–
  theme-automation:
    runs-on: ubuntu-latest
    if: github.event.inputs.tasks == 'all' || github.event.inputs.tasks == 'theme-automation'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 markdown markdownify pygments
    
    - name: Detect Current Theme
      run: |
        python scripts/theme_detector.py
    
    - name: Apply Theme
      run: |
        python scripts/theme_applier.py
    
    - name: Update CSS Variables
      run: |
        python scripts/update_css_variables.py
    
    - name: Generate Theme Info
      run: |
        python scripts/generate_theme_info.py
    
    - name: Commit and Push Changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add css/ stats/theme_info.json
        git diff --staged --quiet || git commit -m "ğŸ¨ Theme automation update - $(date +'%Y-%m-%d')"
        git push
