name: Automation & Maintenance

on:
  schedule:
    # 每天UTC时间00:00运行统计 (北京时间08:00)
    - cron: '0 0 * * *'
    # 每周五UTC时间04:00运行可视化 (北京时间12:00)
    - cron: '0 4 * * 5'
    # 每月1号UTC时间02:00运行SEO优化 (北京时间10:00)
    - cron: '0 2 1 * *'
  workflow_dispatch: # 允许手动触发
    inputs:
      tasks:
        description: '选择要运行的任务'
        required: false
        default: 'all'
        type: choice
        options:
        - 'all'
        - 'daily-stats'
        - 'data-visualization'
        - 'seo-optimization'
        - 'theme-automation'
      force_update:
        description: '强制更新所有数据'
        required: false
        default: false
        type: boolean

jobs:
  # 每日统计和推荐
  daily-stats:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 0 * * *' || github.event.inputs.tasks == 'all' || github.event.inputs.tasks == 'daily-stats'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 markdown markdownify pygments
    
    - name: Generate Daily Statistics
      run: |
        python scripts/generate_daily_stats.py
    
    - name: Generate Problem Recommendation
      run: |
        python scripts/daily_recommendation.py
    
    - name: Update README with Stats
      run: |
        python scripts/update_readme_stats.py
    
    - name: Commit and Push Changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add stats/ README.md
        if ! git diff --staged --quiet; then
          # 随机延迟避免并发冲突
          sleep $((RANDOM % 30 + 10))
          
          # 多次重试推送
          for i in {1..5}; do
            echo "尝试推送 (第 $i 次)"
            git fetch origin main
            git reset --soft origin/main
            git add stats/ README.md
            git commit -m "📊 Daily stats update - $(date +'%Y-%m-%d')" || true
            
            if git push origin main; then
              echo "推送成功！"
              break
            else
              echo "推送失败，等待重试..."
              sleep $((RANDOM % 20 + 5))
            fi
          done
        fi

  # 数据可视化
  data-visualization:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 4 * * 5' || github.event.inputs.tasks == 'all' || github.event.inputs.tasks == 'data-visualization'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 markdown markdownify pygments matplotlib seaborn plotly pandas numpy wordcloud
    
    - name: Generate Charts and Visualizations
      run: |
        python scripts/generate_charts.py
    
    - name: Create Interactive Dashboard
      run: |
        python scripts/create_dashboard.py
    
    - name: Commit and Push Changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add charts/ dashboard/
        if ! git diff --staged --quiet; then
          # 随机延迟避免并发冲突
          sleep $((RANDOM % 30 + 10))
          
          # 多次重试推送
          for i in {1..5}; do
            echo "尝试推送 (第 $i 次)"
            git fetch origin main
            git reset --soft origin/main
            git add charts/ dashboard/
            git commit -m "📊 Data visualization update - $(date +'%Y-%m-%d')" || true
            
            if git push origin main; then
              echo "推送成功！"
              break
            else
              echo "推送失败，等待重试..."
              sleep $((RANDOM % 20 + 5))
            fi
          done
        fi

  # SEO优化
  seo-optimization:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 2 1 * *' || github.event.inputs.tasks == 'all' || github.event.inputs.tasks == 'seo-optimization'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 markdown markdownify pygments
    
    - name: Generate Sitemap
      run: |
        python scripts/generate_sitemap.py
    
    - name: Update Meta Tags
      run: |
        python scripts/update_meta_tags.py
    
    - name: Commit and Push Changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add sitemap.xml
        if ! git diff --staged --quiet; then
          # 随机延迟避免并发冲突
          sleep $((RANDOM % 30 + 10))
          
          # 多次重试推送
          for i in {1..5}; do
            echo "尝试推送 (第 $i 次)"
            git fetch origin main
            git reset --soft origin/main
            git add sitemap.xml
            git commit -m "🔍 SEO optimization update - $(date +'%Y-%m-%d')" || true
            
            if git push origin main; then
              echo "推送成功！"
              break
            else
              echo "推送失败，等待重试..."
              sleep $((RANDOM % 20 + 5))
            fi
          done
        fi

  # 主题自动化
  theme-automation:
    runs-on: ubuntu-latest
    if: github.event.inputs.tasks == 'all' || github.event.inputs.tasks == 'theme-automation'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 markdown markdownify pygments
    
    - name: Detect Current Theme
      run: |
        python scripts/theme_detector.py
    
    - name: Apply Theme
      run: |
        python scripts/theme_applier.py
    
    - name: Update CSS Variables
      run: |
        python scripts/update_css_variables.py
    

    
    - name: Commit and Push Changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add css/
        if ! git diff --staged --quiet; then
          # 随机延迟避免并发冲突
          sleep $((RANDOM % 30 + 10))
          
          # 多次重试推送
          for i in {1..5}; do
            echo "尝试推送 (第 $i 次)"
            git fetch origin main
            git reset --soft origin/main
            git add css/
            git commit -m "🎨 Theme automation update - $(date +'%Y-%m-%d')" || true
            
            if git push origin main; then
              echo "推送成功！"
              break
            else
              echo "推送失败，等待重试..."
              sleep $((RANDOM % 20 + 5))
            fi
          done
        fi
